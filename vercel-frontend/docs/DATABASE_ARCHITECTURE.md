# Database Architecture: Qdrant & PostgreSQL/pgvector

## Overview

Aegis Core uses a dual-database architecture that separates public data (for lead generation) from private data (for compliance and transactions). This architecture enables the "Double-Blind" framework while providing powerful search and discovery capabilities.

## Database 1: Qdrant (Vector Database)

### Purpose
**Lead Generation & Discovery** - The "Profiler" tool uses Qdrant to search public art market data.

### What's Stored
- **Vector Embeddings**: Multimodal embeddings (text + image) generated by Google AI (Vertex AI)
- **Source Documents**: References to public art market documents:
  - Auction catalogs (Sotheby's, Christie's, etc.)
  - Art magazine articles
  - Museum press releases
  - Gallery announcements
  - Public art fair catalogs

### Data Structure (per Qdrant point)
```json
{
  "id": "doc_12345",
  "vector": [0.12, 0.45, ...], // 768-dimensional embedding
  "payload": {
    "source_document": "Sotheby's Contemporary Art Catalog, May 2024, Page 45",
    "source_url": "https://...",
    "implied_keywords": ["minimalist", "sculpture", "contemporary"],
    "medium_focus": "Sculpture",
    "region": "New York",
    "published_at": "2024-05-15",
    "document_type": "auction_catalog"
  }
}
```

### How It Works
1. **Ingestion**: Public documents are continuously ingested via n8n workflows
2. **Processing**: Google AI performs OCR and generates multimodal embeddings
3. **Storage**: Embeddings stored in Qdrant with metadata payloads
4. **Search**: Users upload images or text queries → system generates embedding → searches Qdrant for similar vectors → returns source documents

### Key Features
- **Semantic Search**: Finds artworks/documents by meaning, not just keywords
- **Multimodal**: Searches both text and images
- **Privacy-First**: Only stores public data, never PII or private user information
- **Fast**: Vector similarity search is extremely fast even with millions of documents

### Who Uses It
- **Galleries**: Find new collectors by searching for similar artworks
- **Artists**: Discover where their style appears in public collections
- **Curators**: Research art movements and trends

## Database 2: PostgreSQL with pgvector (Supabase)

### Purpose
**Compliance & Transaction Data** - Stores structured data for the marketplace and compliance workflows.

### What's Stored

#### 1. `collector_leads` Table
Lead candidates produced by the n8n "Lead Scout" workflow:
- `external_id`: Unique identifier
- `full_name`, `organization`, `role`: Public information
- `region`, `medium_focus`: Categorization
- `likelihood`: Match score (0-1)
- `persona_tags`: Array of tags
- `source_url`: Where the lead was found
- `source`: JSON metadata about the source

**Note**: This table stores leads from public data, NOT verified users. Verified users are stored separately in the compliance system.

#### 2. `art_market_events` Table
News and intelligence captured by the "Market Pulse" workflow:
- `headline`, `summary`: Event information
- `source_name`, `source_url`: Source attribution
- `impact_score`: AI-calculated impact (0-1)
- `topics`: Array of relevant topics
- `geography`: JSON with geographic data
- `published_at`: When the event occurred

**Uses pgvector**: Can store embeddings for semantic search of market events.

#### 3. `art_movements` Table
Movement alerts from the "Movement Monitor" workflow:
- `asset_label`: Description of the asset
- `movement_class`: Type of movement
- `origin_region`, `destination_region`: Geographic tracking
- `attention_score`: AI-calculated attention score
- `metadata`: JSON with additional details

#### 4. `artworks` Table
Artwork inventory managed by galleries and artists through the dashboard:
- `id`: UUID primary key
- `title`, `artist`, `year`, `medium`, `dimensions`: Basic artwork information
- `description`, `provenance`: Detailed information
- `price`, `currency`: Pricing information
- `domicile`: Legal domicile (US, EU, etc.)
- `custody_type`, `custody_location`: Physical custody details
- `insurance_provider`, `insurance_policy_number`, `insurance_value`: Insurance information
- `royalty_percentage`, `royalty_recipient`: EIP-2981 royalty configuration
- `tags`: Array of tags for categorization
- `image_urls`: Array of Supabase Storage URLs for artwork images
- `metadata`: JSON for additional metadata
- `status`: Artwork status (`draft`, `listed`, `sold`, etc.)
- `tokenized`: Boolean indicating if artwork has been tokenized
- `master_nft_address`: ERC-721 Master NFT address (if tokenized)
- `token_symbol`: ERC-3643 token symbol (if tokenized)
- `created_at`, `updated_at`: Timestamps

**Storage**: Artwork images are stored in Supabase Storage bucket `artworks` and referenced via `image_urls` array.

### How pgvector Enhances PostgreSQL

PostgreSQL with the `pgvector` extension enables:
- **Hybrid Search**: Combine traditional SQL queries with vector similarity search
- **Semantic Search**: Find market events by meaning, not just keywords
- **RAG Integration**: Use market events as context for AI-generated insights
- **Unified Data**: Store both structured data (metadata) and embeddings in the same database

### Example Query with pgvector
```sql
-- Find market events semantically similar to a query embedding
SELECT headline, summary, impact_score
FROM art_market_events
ORDER BY embedding <=> '[0.12, 0.45, ...]'::vector
LIMIT 10;
```

## How They Work Together

### The Two-Sided Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    PUBLIC DATA LAYER                     │
│  (Qdrant + PostgreSQL collector_leads)                 │
│  • Auction catalogs                                     │
│  • Art publications                                     │
│  • Museum announcements                                 │
│  • Public art fair data                                 │
│  → Used by "The Profiler" for lead generation          │
└─────────────────────────────────────────────────────────┘
                          │
                          │ (Research packets only)
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  PRIVATE DATA LAYER                     │
│  (PostgreSQL compliance tables)                        │
│  • Verified collector attestations                     │
│  • Artwork inventory                                    │
│  • Transaction records                                  │
│  • KYC/AML data (encrypted, law firm access only)      │
│  → Used by "The Exchange" for transactions            │
└─────────────────────────────────────────────────────────┘
```

### The Flow

1. **Lead Discovery (Public → Private)**:
   - Gallery uses Profiler to search Qdrant
   - Receives public source documents
   - Researches documents to find collector names
   - Invites collector via dashboard
   - Collector enters private compliance system

2. **Market Intelligence (Public)**:
   - Market events ingested and stored in PostgreSQL
   - pgvector enables semantic search
   - All users can search and discover trends
   - Helps inform business decisions

3. **Compliance & Transactions (Private)**:
   - Verified collectors stored in compliance system
   - Artworks tokenized and stored on-chain
   - Transactions recorded in PostgreSQL
   - No connection to public Qdrant data

## Benefits for Different User Types

### For Galleries
- **Qdrant**: Find new collectors by searching for artworks similar to yours
- **pgvector**: Discover market trends and events relevant to your inventory
- **Privacy**: Your client list remains completely private

### For Collectors
- **pgvector**: Discover artworks and trends aligned with your interests
- **Market Events**: Stay informed about market dynamics
- **Privacy**: Your identity protected by Double-Blind system

### For Legal Professionals
- **Market Events**: Monitor regulatory developments
- **Compliance Data**: Access verified user attestations (without PII)
- **Risk Assessment**: Track market movements and trends

### For Custodians & Insurers
- **Art Movements**: Track physical movements of artworks
- **Market Intelligence**: Understand market volatility and risk factors
- **Provenance**: Access detailed artwork information and custody records

## Technical Implementation

### Qdrant Setup
- **Collection**: `aegis_leads` or `aegis_art_documents`
- **Vector Size**: 768 (Google AI embedding dimension)
- **Distance Metric**: Cosine similarity
- **Indexing**: HNSW (Hierarchical Navigable Small World) for fast search

### PostgreSQL/pgvector Setup
- **Extension**: `pgvector` enabled
- **Embedding Column**: `vector` type (e.g., `vector(768)`)
- **Indexing**: IVFFlat or HNSW index on vector columns
- **Integration**: Works seamlessly with Supabase

### API Integration
- **Qdrant API**: RESTful API at `http://qdrant:6333`
- **Supabase API**: RESTful API via PostgREST
- **Google AI**: Vertex AI for embedding generation

## Privacy & Security

### Qdrant (Public Data)
- ✅ Only public documents
- ✅ No PII stored
- ✅ No connection to private user data
- ✅ Can be publicly searchable

### PostgreSQL (Private Data)
- ✅ Encrypted at rest
- ✅ Access-controlled by role
- ✅ Law firm data isolated (multi-tenant)
- ✅ Audit logs for compliance

### The "Blind 4" Separation
The Profiler (Qdrant) is completely separate from the Exchange (PostgreSQL compliance data). They never share data, ensuring that:
- Public searches never reveal private user information
- Private transactions never expose public research data
- Complete privacy protection for all participants

