# =============================================================
# Bento: Aegis Art Intelligence Platter
# Uses the Sushi Kitchen rolls/apps to power "The Profiler" stack
# for galleries + artists who need fresh leads, art market context,
# and shipment/ownership monitoring.
# =============================================================

version: "3.9"

x-postgres-url: &postgres_url "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-localhost}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}?sslmode=${POSTGRES_SSLMODE:-require}"

networks:
  aegis-bento-net:
    driver: bridge

volumes:
  redis_data:
  qdrant_data:
  ollama_data:
  n8n_data:
  anythingllm_storage:

services:
  redis:
    image: redis:7-alpine
    container_name: aegis-art-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-aegis_redis}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-aegis_redis}", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data
    networks:
      - aegis-bento-net

  qdrant:
    image: qdrant/qdrant:latest
    container_name: aegis-art-qdrant
    restart: unless-stopped
    ports:
      - "7333:6333"
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - aegis-bento-net

  ollama:
    image: ollama/ollama:latest
    container_name: aegis-art-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      OLLAMA_HOST: "0.0.0.0"
      OLLAMA_KEEP_ALIVE: "10m"
    networks:
      - aegis-bento-net

  postgrest:
    image: postgrest/postgrest:v12.0.1
    container_name: aegis-art-postgrest
    restart: unless-stopped
    environment:
      PGRST_DB_URI: *postgres_url
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: "${POSTGRES_USER:-postgres}"
      PGRST_SERVER_PORT: 3000
    ports:
      - "3000:3000"
    networks:
      - aegis-bento-net

  n8n:
    image: n8nio/n8n:1.81.1
    container_name: aegis-art-n8n
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      N8N_ENCRYPTION_KEY: "${N8N_ENCRYPTION_KEY}"
      N8N_HOST: "${N8N_HOST:-localhost}"
      N8N_PORT: "${N8N_PORT:-5678}"
      N8N_PROTOCOL: http
      N8N_SECURE_COOKIE: "false"
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: "${POSTGRES_HOST:-localhost}"
      DB_POSTGRESDB_PORT: "${POSTGRES_PORT:-5432}"
      DB_POSTGRESDB_DATABASE: "${POSTGRES_DB:-postgres}"
      DB_POSTGRESDB_USER: "${POSTGRES_USER:-postgres}"
      DB_POSTGRESDB_PASSWORD: "${POSTGRES_PASSWORD}"
      DB_POSTGRESDB_SCHEMA: n8n
      GENERIC_TIMEZONE: "${TZ:-UTC}"
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: 6379
      QUEUE_BULL_REDIS_PASSWORD: "${REDIS_PASSWORD:-aegis_redis}"
      ARTSY_CLIENT_ID: "${ARTSY_CLIENT_ID}"
      ARTSY_CLIENT_SECRET: "${ARTSY_CLIENT_SECRET}"
      RESERVOIR_API_KEY: "${RESERVOIR_API_KEY}"
      MARKET_SLACK_WEBHOOK: "${MARKET_SLACK_WEBHOOK}"
      EMBEDDING_MODEL: "${EMBEDDING_MODEL:-nomic-embed-text}"
    ports:
      - "${N8N_PORT:-5678}:${N8N_PORT:-5678}"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/workflows:ro
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5

  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: aegis-art-anythingllm
    restart: unless-stopped
    depends_on:
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_started
    environment:
      STORAGE_DIR: /app/server/storage
      LLM_PROVIDER: ollama
      OLLAMA_BASE_PATH: http://ollama:11434
      EMBEDDING_ENGINE: ollama
      EMBEDDING_BASE_PATH: http://ollama:11434
      VECTOR_DB: qdrant
      QDRANT_ENDPOINT: http://qdrant:6333
      DATABASE_CONNECTION_STRING: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-localhost}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}?sslmode=${POSTGRES_SSLMODE:-require}&options=--search_path%3D${ANYTHINGLLM_PG_SCHEMA:-anythingllm}%2Cpublic"
      JWT_SECRET: "${ANYTHINGLLM_JWT_SECRET:-change_me}"
    ports:
      - "3001:3001"
    volumes:
      - anythingllm_storage:/app/server/storage
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/system"]
      interval: 30s
      timeout: 10s
      retries: 5
