# =============================================================
# Bento: Aegis Art Intelligence Platter
# Uses the Sushi Kitchen rolls/apps to power "The Profiler" stack
# for galleries + artists who need fresh leads, art market context,
# and shipment/ownership monitoring.
# =============================================================

version: "3.9"

x-postgres-url: &postgres_url "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-localhost}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}?sslmode=${POSTGRES_SSLMODE:-require}"

networks:
  aegis-bento-net:
    driver: bridge
    enable_ipv6: true

volumes:
  redis_data:
  qdrant_data:
  ollama_data:
  n8n_data:
  anythingllm_storage:

services:
  redis:
    image: redis:7-alpine
    container_name: aegis-art-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-aegis_redis}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-aegis_redis}", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data
    networks:
      - aegis-bento-net

  qdrant:
    image: qdrant/qdrant:latest
    container_name: aegis-art-qdrant
    restart: unless-stopped
    ports:
      - "7333:6333"
      - "6334:6334"  # gRPC port for Opus integration
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - aegis-bento-net

  qdrant-api:
    build:
      context: ./services/qdrant-api
      dockerfile: Dockerfile
    container_name: aegis-art-qdrant-api
    restart: unless-stopped
    depends_on:
      qdrant:
        condition: service_started
    environment:
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      QDRANT_GRPC_PORT: 6334
      API_KEY: "${QDRANT_API_KEY:-change-me-in-production}"
      CORS_ORIGINS: "${QDRANT_CORS_ORIGINS:-*}"
    ports:
      - "8080:8080"
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  blockchain-api:
    build:
      context: ./services/blockchain-api
      dockerfile: Dockerfile
    container_name: aegis-art-blockchain-api
    restart: unless-stopped
    environment:
      API_KEY: "${BLOCKCHAIN_API_KEY:-change-me-in-production}"
      CORS_ORIGINS: "${BLOCKCHAIN_CORS_ORIGINS:-*}"
      BLOCKCHAIN_RPC_URL: "${BLOCKCHAIN_RPC_URL:-http://localhost:8545}"
      ERC3643_CONTRACT_ADDRESS: "${ERC3643_CONTRACT_ADDRESS:-0x...}"
      ISSUER_WALLET_ADDRESS: "${ISSUER_WALLET_ADDRESS:-0x...}"
      ISSUER_WALLET_PRIVATE_KEY: "${ISSUER_WALLET_PRIVATE_KEY:-}"
    ports:
      - "8081:8081"
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  legal-entity-api:
    build:
      context: ./services/legal-entity-api
      dockerfile: Dockerfile
    container_name: aegis-art-legal-entity-api
    restart: unless-stopped
    environment:
      API_KEY: "${LEGAL_ENTITY_API_KEY:-change-me-in-production}"
      CORS_ORIGINS: "${LEGAL_ENTITY_CORS_ORIGINS:-*}"
      PERSONA_API_KEY: "${PERSONA_API_KEY:-}"
      ONFIDO_API_KEY: "${ONFIDO_API_KEY:-}"
      BLOCKPASS_API_KEY: "${BLOCKPASS_API_KEY:-}"
    ports:
      - "8082:8082"
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  ollama:
    image: ollama/ollama:latest
    container_name: aegis-art-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      OLLAMA_HOST: "0.0.0.0"
      OLLAMA_KEEP_ALIVE: "10m"
    networks:
      - aegis-bento-net

  postgrest:
    image: postgrest/postgrest:v12.0.1
    container_name: aegis-art-postgrest
    restart: unless-stopped
    environment:
      PGRST_DB_URI: *postgres_url
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: "${POSTGRES_USER:-postgres}"
      PGRST_SERVER_PORT: 3000
    ports:
      - "3000:3000"
    networks:
      - aegis-bento-net

  n8n:
    image: n8nio/n8n:1.81.1
    container_name: aegis-art-n8n
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      N8N_ENCRYPTION_KEY: "${N8N_ENCRYPTION_KEY}"
      N8N_HOST: "${N8N_HOST:-localhost}"
      N8N_PORT: "${N8N_PORT:-5678}"
      N8N_PROTOCOL: http
      N8N_SECURE_COOKIE: "false"
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: "${POSTGRES_HOST:-localhost}"
      DB_POSTGRESDB_PORT: "${POSTGRES_PORT:-5432}"
      DB_POSTGRESDB_DATABASE: "${POSTGRES_DB:-postgres}"
      DB_POSTGRESDB_USER: "${POSTGRES_USER:-postgres}"
      DB_POSTGRESDB_PASSWORD: "${POSTGRES_PASSWORD}"
      DB_POSTGRESDB_SCHEMA: n8n
      GENERIC_TIMEZONE: "${TZ:-UTC}"
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: 6379
      QUEUE_BULL_REDIS_PASSWORD: "${REDIS_PASSWORD:-aegis_redis}"
      ARTSY_CLIENT_ID: "${ARTSY_CLIENT_ID}"
      ARTSY_CLIENT_SECRET: "${ARTSY_CLIENT_SECRET}"
      RESERVOIR_API_KEY: "${RESERVOIR_API_KEY}"
      MARKET_SLACK_WEBHOOK: "${MARKET_SLACK_WEBHOOK}"
      EMBEDDING_MODEL: "${EMBEDDING_MODEL:-nomic-embed-text}"
      LITELLM_MASTER_KEY: "${LITELLM_MASTER_KEY:-sk-1234}"
      LITELLM_SCORING_MODEL: "${LITELLM_SCORING_MODEL:-google/gemini-2.5-pro}"
    ports:
      - "${N8N_PORT:-5678}:${N8N_PORT:-5678}"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/workflows:ro
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: aegis-art-litellm
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      LITELLM_MASTER_KEY: "${LITELLM_MASTER_KEY:-sk-1234}"
      AIMLAPI_KEY: "${AIMLAPI_KEY}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
    volumes:
      - ./config/litellm/litellm.yaml:/app/litellm.yaml:ro
    command: litellm --config /app/litellm.yaml --port 4000 --host 0.0.0.0
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: aegis-art-anythingllm
    restart: unless-stopped
    depends_on:
      qdrant:
        condition: service_started
      ollama:
        condition: service_started
    environment:
      STORAGE_DIR: /app/server/storage
      LLM_PROVIDER: ollama
      OLLAMA_BASE_PATH: http://ollama:11434
      EMBEDDING_ENGINE: ollama
      EMBEDDING_BASE_PATH: http://ollama:11434
      VECTOR_DB: qdrant
      QDRANT_ENDPOINT: http://qdrant:6333
      DATABASE_CONNECTION_STRING: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-localhost}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}?sslmode=${POSTGRES_SSLMODE:-require}&options=--search_path%3D${ANYTHINGLLM_PG_SCHEMA:-anythingllm}%2Cpublic"
      JWT_SECRET: "${ANYTHINGLLM_JWT_SECRET:-change_me}"
    ports:
      - "3001:3001"
    volumes:
      - anythingllm_storage:/app/server/storage
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/system"]
      interval: 30s
      timeout: 10s
      retries: 5
