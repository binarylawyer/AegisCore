# =============================================================
# Bento: Aegis Art Intelligence Platter
# Uses the Sushi Kitchen rolls/apps to power "The Profiler" stack
# for galleries + artists who need fresh leads, art market context,
# and shipment/ownership monitoring.
# =============================================================

version: "3.9"

x-postgres-url: &postgres_url "postgresql://${POSTGRES_USER:-aegis_admin}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-aegis_intel}"

networks:
  aegis-bento-net:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
  ollama_data:
  n8n_data:
  anythingllm_storage:

services:
  postgres:
    image: postgres:15
    container_name: aegis-art-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-aegis_admin}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-change_me}"
      POSTGRES_DB: "${POSTGRES_DB:-aegis_intel}"
      TZ: "${TZ:-UTC}"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-aegis_admin}"]
      interval: 30s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql/aegis_art_intel_init.sql:/docker-entrypoint-initdb.d/001_aegis_art_intel.sql:ro
    networks:
      - aegis-bento-net

  redis:
    image: redis:7-alpine
    container_name: aegis-art-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-aegis_redis}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-aegis_redis}", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data
    networks:
      - aegis-bento-net

  qdrant:
    image: qdrant/qdrant:latest
    container_name: aegis-art-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - aegis-bento-net

  ollama:
    image: ollama/ollama:latest
    container_name: aegis-art-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      OLLAMA_HOST: "0.0.0.0"
      OLLAMA_KEEP_ALIVE: "10m"
    networks:
      - aegis-bento-net

  litellm:
    image: ghcr.io/berriai/litellm:main
    container_name: aegis-art-litellm
    restart: unless-stopped
    depends_on:
      - ollama
    environment:
      LITELLM_CONFIG: /etc/litellm/config.yaml
      LITELLM_MASTER_KEY: "${LITELLM_MASTER_KEY:-litellm_master_key}"
      PORT: 4000
      HOST: 0.0.0.0
    volumes:
      - ./config/litellm/litellm.yaml:/etc/litellm/config.yaml:ro
    ports:
      - "4000:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - aegis-bento-net

  postgrest:
    image: postgrest/postgrest:v12.0.1
    container_name: aegis-art-postgrest
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGRST_DB_URI: *postgres_url
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: "${POSTGRES_USER:-aegis_admin}"
      PGRST_SERVER_PORT: 3000
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/collector_leads?limit=1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - aegis-bento-net

  n8n:
    image: n8nio/n8n:1.81.1
    container_name: aegis-art-n8n
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      litellm:
        condition: service_healthy
      postgrest:
        condition: service_healthy
    environment:
      N8N_ENCRYPTION_KEY: "${N8N_ENCRYPTION_KEY}"
      N8N_HOST: "${N8N_HOST:-localhost}"
      N8N_PORT: "${N8N_PORT:-5678}"
      N8N_PROTOCOL: http
      N8N_SECURE_COOKIE: "false"
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: "${POSTGRES_DB:-aegis_intel}"
      DB_POSTGRESDB_USER: "${POSTGRES_USER:-aegis_admin}"
      DB_POSTGRESDB_PASSWORD: "${POSTGRES_PASSWORD}"
      DB_POSTGRESDB_SCHEMA: n8n
      GENERIC_TIMEZONE: "${TZ:-UTC}"
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: 6379
      QUEUE_BULL_REDIS_PASSWORD: "${REDIS_PASSWORD:-aegis_redis}"
      ARTSY_CLIENT_ID: "${ARTSY_CLIENT_ID}"
      ARTSY_CLIENT_SECRET: "${ARTSY_CLIENT_SECRET}"
      RESERVOIR_API_KEY: "${RESERVOIR_API_KEY}"
      MARKET_SLACK_WEBHOOK: "${MARKET_SLACK_WEBHOOK}"
      LITELLM_MASTER_KEY: "${LITELLM_MASTER_KEY:-litellm_master_key}"
      LITELLM_BASE_URL: "http://litellm:4000"
      LITELLM_SCORING_MODEL: "${LITELLM_SCORING_MODEL:-gpt-4o-mini}"
      EMBEDDING_MODEL: "${EMBEDDING_MODEL:-nomic-embed-text}"
    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/workflows:ro
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5

  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: aegis-art-anythingllm
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_started
    environment:
      STORAGE_DIR: /app/server/storage
      LLM_PROVIDER: ollama
      OLLAMA_BASE_PATH: http://ollama:11434
      EMBEDDING_ENGINE: ollama
      EMBEDDING_BASE_PATH: http://ollama:11434
      VECTOR_DB: qdrant
      QDRANT_ENDPOINT: http://qdrant:6333
      DATABASE_CONNECTION_STRING: "postgresql://${POSTGRES_USER:-aegis_admin}:${POSTGRES_PASSWORD}@postgres:5432/anythingllm"
      JWT_SECRET: "${ANYTHINGLLM_JWT_SECRET:-change_me}"
    ports:
      - "3001:3001"
    volumes:
      - anythingllm_storage:/app/server/storage
    networks:
      - aegis-bento-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/system"]
      interval: 30s
      timeout: 10s
      retries: 5

